<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Recipe Quest</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Définition des variables "Premium Nuit" (Défaut) AVEC ACCENT ROUGE */
        :root {
            --bg-primary: #121212;      /* Fond principal (Presque noir) */
            --bg-secondary: #1E1E1E;    /* Fond des panneaux (Gris très sombre) */
            --bg-tertiary: #333333;     /* Fond des inputs et bordures */
            --text-primary: #F5F5F5;    /* Texte principal (Presque blanc) */
            --text-secondary: #888888;  /* Texte grisé (Muted) */
            --accent: #DC2626;          /* Accent (ROUGE VIF) */
            --accent-hover: #B91C1C;    /* Accent au survol (ROUGE FONCÉ) */
            --card-border: #333333;     /* Bordure des cartes */
        }

        /* Thème "Gourmet Clair" (Mode Jour) - S'active quand le body a la classe .light-mode */
        body.light-mode {
            --bg-primary: #F9FAFB;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #E5E7EB;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --accent: #DC2626;     /* Rouge 600 (Cohérent) */
            --accent-hover: #B91C1C; /* Rouge 700 (Cohérent) */
            --card-border: #E5E7EB;
        }

        /* Réinitialisation de base */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Thème Moderne / Futuriste */
        body {
            font-family: 'Inter', sans-serif; /* Police lisible */
            font-size: 16px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        h1, h2, h3 {
            font-weight: 700;
        }

        h1 {
            font-size: 28px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 30px;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }
        
        h2 {
            font-size: 14px;
            margin-bottom: 15px;
            color: var(--accent); /* Accent (Rouge ou Ambre) */
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        h3 {
            font-size: 18px;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-weight: 700;
        }

        /* Conteneur principal */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        /* Panneaux (anciennement .window-box) */
        .window-box {
            background-color: var(--bg-secondary); /* Fond panneau */
            border: 1px solid var(--card-border); /* Bordure légère */
            border-radius: 12px; /* Coins arrondis */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* Ombre subtile */
            margin-bottom: 25px;
            padding: 24px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        /* Grille de mise en page (structure conservée) */
        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 25px;
            flex-grow: 1;
            min-height: 0;
        }
        
        /* Adaptation Mobile Parfaite */
        @media (max-width: 900px) {
            body {
                padding: 15px;
            }
            .container {
                height: auto;
            }
            .main-layout {
                grid-template-columns: 1fr;
                gap: 15px; /* Espace réduit sur mobile */
            }
            .window-box {
                padding: 15px; /* Padding réduit sur mobile */
            }
            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }
            .type-buttons {
                gap: 8px; /* Grille plus serrée */
            }
            .checkbox-group {
                gap: 8px;
            }
        }
        
        aside.window-box {
             margin-bottom: 0;
        }
        
        main.window-box {
            display: flex;
            flex-direction: column;
            margin-bottom: 0;
        }

        /* --- FILTRES (Panneau de Contrôle) --- */
        
        .filter-group {
            margin-bottom: 24px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 14px;
        }

        select, .pixel-button {
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            background-color: var(--bg-primary); /* Fond (inset) */
            color: var(--text-primary);
            border: 1px solid var(--bg-tertiary);
            padding: 10px 12px;
            width: 100%;
            border-radius: 8px; /* Coins arrondis */
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent); /* Lueur d'accent */
        }

        /* Boutons (anciennement .pixel-button) */
        .pixel-button {
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            text-transform: none;
            border: 1px solid var(--bg-tertiary);
            background-color: transparent;
            color: var(--text-secondary);
            transition: all 0.2s ease-in-out;
        }
        
        @media (hover: hover) {
            .pixel-button:not(.active):not(.locked):hover {
                background-color: var(--bg-tertiary);
                border-color: var(--bg-tertiary);
                color: var(--text-primary);
            }
        }

        .type-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        /* Bouton Actif (Style de base) */
        .pixel-button.active {
            border-color: var(--accent);
            font-weight: 600;
            background-color: var(--accent); /* Rouge solide pour les DEUX modes */
            color: #FFFFFF; /* Texte blanc pour les DEUX modes */
        }
        
        .pixel-button.locked {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            opacity: 0.6;
            cursor: not-allowed;
            border-color: var(--bg-tertiary);
        }

        /* --- NOUVEAU STYLE (ÉTAPE 2) --- */
        .discreet-button {
            background: none;
            border: none;
            color: var(--text-secondary); /* Grisé */
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: color 0.2s ease, background-color 0.2s ease;
        }
        .discreet-button:hover {
            color: var(--text-primary);
            background-color: var(--bg-tertiary);
        }
        /* --- FIN NOUVEAU STYLE --- */

        /* Slider de temps */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            padding: 0;
            border: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border: 3px solid var(--bg-secondary);
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--accent-hover);
        }
        
        #time-value {
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 500;
            text-align: right;
            margin-top: 8px;
        }

        /* Checkboxes modernes */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, minmax(min-content, 1fr));
            gap: 10px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 15px;
            color: var(--text-secondary);
            transition: color 0.2s ease;
            white-space: nowrap; /* Correction layout "Légumineuse" */
        }
        
        .checkbox-label:hover {
            color: var(--text-primary);
        }
        
        .checkbox-label input {
            display: none;
        }
        
        .checkbox-label .custom-checkbox {
            width: 18px;
            height: 18px;
            background-color: var(--bg-primary);
            border: 2px solid var(--bg-tertiary);
            border-radius: 4px;
            margin-right: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s ease;
            flex-shrink: 0; /* Empêche le checkbox de rétrécir */
        }
        
        .checkbox-label input:checked + .custom-checkbox {
            background-color: var(--accent);
            border-color: var(--accent);
        }

        .checkbox-label .custom-checkbox::after {
            content: '';
            position: absolute;
            display: none;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            top: 2px;
        }

        .checkbox-label input:checked + .custom-checkbox::after {
            display: block;
        }

        /* --- LISTE DE RECETTES --- */
        #recipe-list {
            flex-grow: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 10px;
            background-color: var(--bg-primary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 8px;
        }
        
        /* Scrollbar moderne */
        #recipe-list::-webkit-scrollbar {
            width: 10px;
        }
        #recipe-list::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 10px;
        }
        #recipe-list::-webkit-scrollbar-thumb {
            background-color: var(--bg-tertiary);
            border-radius: 10px;
            border: 2px solid var(--bg-primary);
        }
        #recipe-list::-webkit-scrollbar-thumb:hover {
            background-color: var(--text-secondary);
        }

        .recipe-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--card-border);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .recipe-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        
        body.light-mode .recipe-card:hover {
             box-shadow: 0 4px 10px rgba(0,0,0,0.07);
        }
        
        .recipe-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .recipe-original-name {
            font-size: 16px;
            color: var(--accent);
            font-weight: 500;
        }
        
        .recipe-origin {
            font-size: 15px;
            color: var(--text-secondary);
            text-align: right;
            flex-shrink: 0;
            padding-left: 10px;
        }

        .recipe-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            border-top: 1px dashed var(--bg-tertiary);
            border-bottom: 1px dashed var(--bg-tertiary);
            padding: 10px 0;
        }
        
        .recipe-time {
            font-size: 15px;
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .recipe-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        /* Tags monochromes et professionnels */
        .tag {
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 99px; /* Pill shape */
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: var(--bg-tertiary); /* Gris clair */
            color: var(--text-secondary); /* Gris moyen */
        }
        
        /* Thème sombre : Tags plus foncés */
        body:not(.light-mode) .tag {
            background-color: #2a2a2a;
            color: #9CA3AF;
        }
        
        /* Thème clair : Tags plus clairs */
        body.light-mode .tag {
             background-color: #F3F4F6;
             color: #4B5563;
        }
        
        /* Exception "Piquant" pour les deux modes (Cohérent avec l'accent ROUGE) */
        body:not(.light-mode) .tag.tag-epice_piquant { 
            background-color: #450a0a; /* Rouge Nuit Fond */
            color: #F87171; /* Rouge Nuit Texte */
        }
         body.light-mode .tag.tag-epice_piquant { 
            background-color: #FEE2E2; /* Rouge Jour Fond */
            color: #B91C1C; /* Rouge Jour Texte */
        }

        /* AMÉLIORATION : Distinction Description / Ingrédients (Inversé) */
        .recipe-description {
            margin-bottom: 12px;
            font-size: 15px;
            color: var(--text-primary); /* Description en couleur principale */
            line-height: 1.6;
        }
        
        .recipe-ingredients {
            font-size: 14px;
            color: var(--text-secondary); /* Ingrédients en retrait (grisé) */
            line-height: 1.5;
        }
        .recipe-ingredients strong {
            color: var(--text-secondary); /* Titre "Ingrédients" aussi en retrait */
            font-weight: 600; /* Garder un peu de poids */
        }

    </style>
</head>

<body>

    <div class="container">
        <h1>World Recipe Quest</h1>

        <div class="main-layout">
            
            <aside class="window-box" id="filters-ui">

                <div class="filter-group">
                    <button class="pixel-button" id="theme-toggle" style="width: 100%; background-color: var(--bg-tertiary); color: var(--text-primary);">Passer au Mode Jour</button>
                </div>
                
                <div class="filter-group">
                    <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 15px;">
                        <h2 style="margin-bottom: 0;">Type de Plat</h2>
                        <button id="toggle-types-button" class="discreet-button">Tout Désél.</button>
                    </div>
                    <div class="type-buttons">
					    <button class="pixel-button active" data-type="Mijoté">Mijoté</button>
					    <button class="pixel-button active" data-type="Sauté">Sauté</button>
					    <button class="pixel-button active" data-type="Grill">Grill</button>
					    <button class="pixel-button active" data-type="Soupe">Soupe</button>
						<button class="pixel-button active" data-type="Vapeur">Vapeur</button>
                        <button class="pixel-button active" data-type="Four / Rôtir">Four / Rôtir</button>
                        <button class="pixel-button active" data-type="Frire">Frire</button>
                        <button class="pixel-button active" data-type="Froid / Cru">Froid / Cru</button>
				    </div>
                </div>
                <div class="filter-group">
                    <h2>Destination</h2>
                    <label for="continent-filter">Continent:</label>
                    <select id="continent-filter">
                        <option value="Tous">-- TOUS --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="country-filter">Pays:</label>
                    <select id="country-filter">
                        <option value="Tous">-- TOUS --</option>
                    </select>
                </div>

                <div class="filter-group">
                    <h2>Temps Prépa (Max)</h2>
                    <input type="range" id="time-filter" min="30" max="720" value="720" step="15">
                    <div id="time-value">Jusqu'à 12h 00m</div>
                </div>

                <div class="filter-group">
                    <h2>Ingrédients</h2>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" class="tag-filter" value="viande">
                            <span class="custom-checkbox"></span>
                            Viande
                        </label>
						<label class="checkbox-label">
                            <input type="checkbox" class="tag-filter" value="poisson">
                            <span class="custom-checkbox"></span>
                            Poisson
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="tag-filter" value="fruit_de_mer">
                            <span class="custom-checkbox"></span>
                            Fruits de mer
                        </label>
						<label class="checkbox-label">
                            <input type="checkbox" class="tag-filter" value="legumes">
                            <span class="custom-checkbox"></span>
                            Légumes
                        </label>
						<label class="checkbox-label">
                            <input type="checkbox" class="tag-filter" value="riz">
                            <span class="custom-checkbox"></span>
                            Riz
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="tag-filter" value="pates">
                            <span class="custom-checkbox"></span>
                            Pâtes
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="tag-filter" value="legumineuse">
                            <span class="custom-checkbox"></span>
                            Légumineuse
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="tag-filter" value="cereales">
                            <span class="custom-checkbox"></span>
                            Céréales
                        </label>
						<label class="checkbox-label">
                            <input type="checkbox" class="tag-filter" value="oeuf">
                            <span class="custom-checkbox"></span>
                            Oeuf
                        </label>
						<label class="checkbox-label">
                            <input type="checkbox" class="tag-filter" value="champignons">
                            <span class="custom-checkbox"></span>
                            Champignons
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="tag-filter" value="epices">
                            <span class="custom-checkbox"></span>
                            Épices
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="tag-filter" value="herbes">
                            <span class="custom-checkbox"></span>
                            Herbes
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="tag-filter" value="epice_piquant">
                            <span class="custom-checkbox"></span>
                            Piquant
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="tag-filter" value="vegetarien">
                            <span class="custom-checkbox"></span>
                            Végétarien
                        </label>
                    </div>
                </div>
                
                 <div class="filter-group">
                    <button class="pixel-button" id="reset-button" style="background-color: var(--bg-tertiary); color: var(--text-primary);">RESET FILTRES</button>
                 </div>

            </aside>
            
            <main class="window-box">
                <h2 id="recipe-count">Chargement des recettes...</h2>
                <div id="recipe-list">
                    </div>
            </main>

        </div>
    </div> 

<script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- ÉLÉMENTS DU DOM ---
        const continentFilter = document.getElementById('continent-filter');
        const countryFilter = document.getElementById('country-filter');
        const timeFilter = document.getElementById('time-filter');
        const timeValue = document.getElementById('time-value');
        const tagFilters = document.querySelectorAll('.tag-filter');
        const recipeList = document.getElementById('recipe-list');
        const recipeCount = document.getElementById('recipe-count');
        const resetButton = document.getElementById('reset-button');
        const themeToggle = document.getElementById('theme-toggle');
        const typeButtonsContainer = document.querySelector('.type-buttons');
        // --- NOUVEL ÉLÉMENT (ÉTAPE 3) ---
        const toggleTypesButton = document.getElementById('toggle-types-button');

        // --- ÉTAT GLOBAL (Simplifié) ---
        let populatedContinents = [];
        let populatedCountries = [];
        let allTypes = [];
        let selectedRecipeTypes = [];
        let allRecipesRaw = []; // Pour les filtres de pays/continent
        
        // 1. Démarrer l'assistant
        const filterWorker = new Worker('filter.worker.js'); // Nom du nouveau fichier

        // --- FONCTIONS AUXILIAIRES (Juste le DOM) ---

        function formatTime(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            let timeString = "";
            if (h > 0) timeString += `${h}h `;
            if (m > 0) timeString += `${m.toString().padStart(2, '0')}m`;
            return timeString || "0m";
        }

        function createRecipeCard(recipe) {
            const card = document.createElement('div');
            card.className = 'recipe-card';
            
            const tagsHTML = (recipe.tags || []).map(tag => {
                let tagName = tag.replace(/_/g, ' ');
                return `<span class="tag tag-${tag}">${tagName.toUpperCase()}</span>`;
            }).join('');

            const displayedIngredients = recipe.ingredients.join(', ');

            card.innerHTML = `
                <div class="recipe-card-header">
                    <div>
                        <h3>${recipe.name}</h3>
                        <div class="recipe-original-name">${recipe.originalName}</div>
                    </div>
                    <div class="recipe-origin">${recipe.flag} ${recipe.country}<br>(${recipe.continent})</div>
                </div>
                <div class="recipe-info">
                    <div class="recipe-time">${formatTime(recipe.prepTime)}</div>
                    <div class="recipe-tags">${tagsHTML}</div>
                </div>
                <div class="recipe-description">${recipe.description}</div>
                <div class="recipe-ingredients"><strong>Ingrédients:</strong> ${displayedIngredients}</div>
            `;
            return card;
        }

        // --- LOGIQUE DE L'INTERFACE ---

        function populateFilters(recipes) {
            const continents = new Set();
            const countries = new Set();
            const types = new Set();

            recipes.forEach(recipe => {
                continents.add(recipe.continent);
                countries.add(recipe.country);
                types.add(recipe.type);
            });
            
            populatedContinents = Array.from(continents).sort((a, b) => a.localeCompare(b, 'fr'));
            populatedCountries = Array.from(countries).sort((a, b) => a.localeCompare(b, 'fr'));
            allTypes = Array.from(types).sort();

            continentFilter.innerHTML = '<option value="Tous">-- TOUS --</option>';
            populatedContinents.forEach(continent => {
                const option = document.createElement('option');
                option.value = continent;
                option.textContent = continent;
                continentFilter.appendChild(option);
            });
            
            updateCountryFilter(true);
            
            selectedRecipeTypes = [...allTypes];
            document.querySelectorAll('.type-buttons .pixel-button').forEach(btn => {
                const type = btn.dataset.type;
                if (allTypes.includes(type)) {
                    btn.classList.add('active');
                    btn.disabled = false;
                } else {
                    btn.classList.add('locked');
                    btn.disabled = true;
                    btn.classList.remove('active');
                }
            });

            // --- MISE À JOUR (ÉTAPE 4) ---
            // S'assurer que le texte du bouton est correct au démarrage
            updateToggleTypesButtonText();
        }

        function updateCountryFilter(initial = false) {
            const selectedContinent = continentFilter.value;
            const currentCountryValue = countryFilter.value; 
            
            countryFilter.innerHTML = '<option value="Tous">-- TOUS --</option>';
            let countriesToShow;
            
            if (selectedContinent === 'Tous') {
                countriesToShow = populatedCountries;
            } else {
                const countries = new Set();
                allRecipesRaw.forEach(recipe => { 
                    if (recipe.continent === selectedContinent) {
                        countries.add(recipe.country);
                    }
                });
                countriesToShow = Array.from(countries).sort((a, b) => a.localeCompare(b, 'fr'));
            }

            countriesToShow.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            });

            if (countriesToShow.includes(currentCountryValue)) {
                 countryFilter.value = currentCountryValue;
            } else if (!initial) {
                 countryFilter.value = 'Tous';
            }
        }

        function requestRender() {
            const filters = {
                continent: continentFilter.value,
                country: countryFilter.value,
                maxTime: parseInt(timeFilter.value, 10),
                tags: Array.from(tagFilters)
                            .filter(input => input.checked)
                            .map(input => input.value)
            };
            
            filterWorker.postMessage({
                type: 'FILTER',
                payload: {
                    filters: filters,
                    selectedRecipeTypes: selectedRecipeTypes
                }
            });
        }

        function updateDOM(filteredRecipes) {
            recipeList.innerHTML = '';
            recipeCount.textContent = `${filteredRecipes.length} RECETTES TROUVÉES`;
            
            const fragment = document.createDocumentFragment(); 

            if (filteredRecipes.length === 0) {
                const noResult = document.createElement('div');
                noResult.className = 'recipe-card';
                noResult.innerHTML = '<h3>Aucune recette trouvée!</h3><p>Essayez d\'élargir vos filtres.</p>';
                fragment.appendChild(noResult);
            } else {
                filteredRecipes.forEach(recipe => {
                    fragment.appendChild(createRecipeCard(recipe));
                });
            }
            
            recipeList.appendChild(fragment);
        }

        function resetFilters() {
            continentFilter.value = 'Tous';
            updateCountryFilter(); 
            countryFilter.value = 'Tous';
            timeFilter.value = 720;
            timeValue.textContent = 'Jusqu\'à 12h 00m';
            tagFilters.forEach(input => input.checked = false);
            
            selectedRecipeTypes = [...allTypes];
            document.querySelectorAll('.type-buttons .pixel-button').forEach(btn => {
                 if (allTypes.includes(btn.dataset.type)) {
                     btn.classList.add('active');
                 }
             });
            
            // --- MISE À JOUR (ÉTAPE 4) ---
            updateToggleTypesButtonText(); // Mettre à jour le texte du bouton
			
            requestRender();
        }

        // --- NOUVELLE FONCTION (ÉTAPE 3) ---
        // Fonction pour mettre à jour le texte du bouton "Tout/Rien"
        function updateToggleTypesButtonText() {
            if (selectedRecipeTypes.length === allTypes.length) {
                toggleTypesButton.textContent = 'Tout Désél.';
            } else {
                toggleTypesButton.textContent = 'Tout Sél.';
            }
        }

        // --- DÉMARRAGE ---
        
        filterWorker.onmessage = function(e) {
            updateDOM(e.data);
        };

        // --- CORRECTION BUG 1 (Chemin du Fichier) ---
        // Doit être 'recettes.json' (avec accent) pour GitHub
        fetch('recettes.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erreur HTTP! Statut: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                allRecipesRaw = data; 
                
                filterWorker.postMessage({
                    type: 'LOAD_DATA',
                    payload: data
                });

                populateFilters(data);
                requestRender();
            })
            .catch(error => {
                console.error("Erreur de chargement des recettes:", error);
                recipeCount.textContent = "ERREUR: Recettes non chargées. Vérifiez le fichier 'recettes.json'.";
            });

        // --- ÉCOUTEURS D'ÉVÉNEMENTS ---
        
        typeButtonsContainer.addEventListener('click', (event) => {
            const clickedButton = event.target;
            if (clickedButton.tagName === 'BUTTON' && !clickedButton.disabled) {
                const type = clickedButton.dataset.type;
                const index = selectedRecipeTypes.indexOf(type);
                if (index > -1) {
                    selectedRecipeTypes.splice(index, 1);
                    clickedButton.classList.remove('active');
                } else {
                    selectedRecipeTypes.push(type);
                    clickedButton.classList.add('active');
                }
                requestRender(); // Demande à l'assistant
                
                // --- MISE À JOUR (ÉTAPE 4) ---
                updateToggleTypesButtonText(); // Mettre à jour le texte du bouton
            }
        });

        // --- NOUVEL ÉCOUTEUR (ÉTAPE 3) ---
        toggleTypesButton.addEventListener('click', () => {
            const allTypeButtons = document.querySelectorAll('.type-buttons .pixel-button');
            
            // Si tout est déjà sélectionné (ou la plupart), on désélectionne tout
            if (selectedRecipeTypes.length > 0) {
                selectedRecipeTypes = []; // Vider la liste
                allTypeButtons.forEach(btn => {
                    btn.classList.remove('active'); // Enlever 'active' de TOUS les boutons
                });
            } 
            // Sinon (si 0 est sélectionné), on sélectionne tout
            else {
                selectedRecipeTypes = [...allTypes]; // Remplir la liste
                allTypeButtons.forEach(btn => {
                    if (allTypes.includes(btn.dataset.type)) {
                        btn.classList.add('active');
                    }
                });
            }
            
            updateToggleTypesButtonText(); // Mettre à jour le texte du bouton
            requestRender(); // Mettre à jour la vue
        });


        continentFilter.addEventListener('change', () => {
            updateCountryFilter();
            requestRender();
        });
        countryFilter.addEventListener('change', requestRender);
        
        timeFilter.addEventListener('input', () => {
            timeValue.textContent = `Jusqu'à ${formatTime(parseInt(timeFilter.value, 10))}`;
        });
        timeFilter.addEventListener('change', requestRender); 
        
        // --- CORRECTION BUG 2 (Nom de la fonction) ---
        // Doit appeler 'requestRender' et non 'renderRecipes' (qui n'existe plus en tant qu'alias)
        tagFilters.forEach(input => input.addEventListener('change', requestRender));
        
        resetButton.addEventListener('click', resetFilters);
        
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            themeToggle.textContent = isLight ? 'Passer au Mode Nuit' : 'Passer au Mode Jour';
        });
        
        // (L'alias 'renderRecipes' n'est plus nécessaire)
						
    });
</script>
</body>
</html>
